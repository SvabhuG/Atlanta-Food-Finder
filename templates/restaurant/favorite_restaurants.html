<div class="container">
    <h2>My Favorite Restaurants</h2>

    <!-- Button to go back to the main search page -->
    <div class="mb-4">
        <a href="{% url 'search_restaurants' %}" class="btn btn-secondary">Back to Search</a>
    </div>

    <div class="row mt-4">
        <!-- Left column: favorite restaurants -->
        <div class="col-md-8">
            <div class="row">
                {% for data in restaurant_data %}
                <div class="col-md-6 mb-4">
                    <div class="card">
                        <!-- Restaurant photo using Google Maps API -->
                        <img src="https://maps.googleapis.com/maps/api/place/photo?maxwidth=400&photoreference={{ data.restaurant.restaurant_photo_reference }}&key={{ google_maps_api_key }}" class="card-img-top" alt="{{ data.restaurant.restaurant_name }}">
                        <div class="card-body">
                            <h5 class="card-title">{{ data.restaurant.restaurant_name }}</h5>
                            <p class="card-text">{{ data.restaurant.restaurant_address }}</p>
                            <p class="card-text">Rating: {{ data.restaurant.restaurant_rating }}</p>
                            <p class="card-text">Phone Number: {{ data.phone_number }}</p>

                            <!-- Display the first 2 reviews for each restaurant -->
                            <h6>Google Reviews:</h6>
                            {% if data.reviews %}
                                <ul class="list-group">
                                    {% for review in data.reviews|slice:":2" %}
                                        <li class="list-group-item">
                                            <strong>{{ review.author_name }}</strong> rated {{ review.rating }} stars
                                            <p>{{ review.text }}</p>
                                            <small>{{ review.relative_time_description }}</small>
                                        </li>
                                    {% endfor %}
                                </ul>
                            {% else %}
                                <p>No reviews available.</p>
                            {% endif %}

                            <!-- Unlike button -->
                            <form method="post" action="{% url 'unlike_restaurant' data.restaurant.id %}">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-danger">Unlike</button>
                            </form>
                        </div>
                    </div>
                </div>
                {% empty %}
                <p>You haven't liked any restaurants yet.</p>
                {% endfor %}
            </div>
        </div>

        <!-- Right column: Map -->
        <div class="col-md-4">
            <div id="map" style="height: 500px; width: 100%;"></div>
        </div>
    </div>
</div>

<script>
    let map;
    let markers = []; // Array to hold markers

    function initMap() {
        // Create a map centered on a default location (Atlanta)
        map = new google.maps.Map(document.getElementById('map'), {
            zoom: 12,
            center: {lat: 33.7490, lng: -84.3880} // Default center on Atlanta
        });

        // Clear existing markers
        markers.forEach(marker => marker.setMap(null));
        markers = [];

        // Loop through the favorite restaurants and add markers to the map
        {% for data in restaurant_data %}
        addMarker({
            lat: {{ data.restaurant.latitude }},
            lng: {{ data.restaurant.longitude }},
            name: "{{ data.restaurant.restaurant_name }}",
            address: "{{ data.restaurant.restaurant_address }}"
        });
        {% endfor %}
    }

    function addMarker(place) {
        const marker = new google.maps.Marker({
            position: {lat: place.lat, lng: place.lng},
            map: map,
            title: place.name
        });

        const infowindow = new google.maps.InfoWindow({
            content: `<h5>${place.name}</h5><p>${place.address}</p>`
        });

        marker.addListener('click', function() {
            infowindow.open(map, marker);
        });

        markers.push(marker);
    }

    // Initialize the map when the page loads
    window.onload = initMap;
</script>

<!-- Include the Google Maps API -->
<script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&callback=initMap" async defer></script>
